CREATE VIEW EMBCPROD.V_EVENT_SITSUM (
   REPORT_NAME, 
   UNIQUE_KEY, 
   REPORT_VERSION, 
   FOREIGN_DOC, 
   SUMMARY, 
   ENTERED_BY, 
   ENTRY_DATE, 
   ORGANIZATION, 
   CREATED_BY, 
   CREATION_DATE, 
   MODIFIED_BY, 
   MODIFICATION_DATE, 
   STATUS, 
   PARENT_REPORT_UNIQUE_KEY)
AS 
   SELECT 
      REPT.REPORT_NAME, 
      SS.GLOBAL_SUMMARY_ID AS UNIQUE_KEY, 
      /*CASE SS.STATUS WHEN 'O' THEN 'Yes' ELSE CASE (INSTR(REPT.SITSUM_ID_LIST,SS.GLOBAL_SUMMARY_ID, 1, 1)) WHEN 0 THEN 'Yes' ELSE 'No' END END History_version, CASE REPT.STATUS WHEN 'D' THEN 'Yes' ELSE 'No' END Deleted,*/CASE ssma_oracle.instr4_varchar(REPT.SITSUM_ID_LIST, SS.GLOBAL_SUMMARY_ID, 1, 1)
         WHEN 0 THEN CASE SS.STATUS
            WHEN 'O' THEN 'History'
            WHEN 'A' THEN 'Deleted'
         END
         ELSE 'Active'
      END AS REPORT_VERSION, 
      CASE SS.CREATED_BY
         WHEN NULL THEN 'Yes'
         ELSE 'No'
      END AS FOREIGN_DOC, 
      ssma_oracle.dbms_lob$substr_clob(SS.SUMMARY, 4000, 1) AS SUMMARY, 
      SS.ENTERED_BY, 
      SS.ENTRY_DATE, 
      SS.ORGANIZATION, 
      CASE 
         WHEN UC.USER_NAME IS NULL THEN 
            (
               SELECT TBL_REMOTE_DOCUMENT_USER_INFO.CREATED_BY_USER_LOGIN_ID
               FROM EMBCPROD.TBL_REMOTE_DOCUMENT_USER_INFO
               WHERE TBL_REMOTE_DOCUMENT_USER_INFO.GLOBAL_REPORT_ID = SS.GLOBAL_SUMMARY_ID
            )
         ELSE UC.USER_NAME
      END AS CREATED_BY, 
      SS.CREATION_DATE, 
      CASE 
         WHEN UM.USER_NAME IS NULL THEN 
            (
               SELECT TBL_REMOTE_DOCUMENT_USER_INFO$2.MODIFIED_BY_USER_LOGIN_ID
               FROM EMBCPROD.TBL_REMOTE_DOCUMENT_USER_INFO  AS TBL_REMOTE_DOCUMENT_USER_INFO$2
               WHERE TBL_REMOTE_DOCUMENT_USER_INFO$2.GLOBAL_REPORT_ID = SS.GLOBAL_SUMMARY_ID
            )
         ELSE UM.USER_NAME
      END AS MODIFIED_BY, 
      SS.MODIFICATION_DATE, 
      SS.STATUS, 
      REPT.GLOBAL_REPORT_ID AS PARENT_REPORT_UNIQUE_KEY
   FROM 
      EMBCPROD.TBL_SITUATION_SUMMARY  AS SS 
         LEFT JOIN EMBCPROD.TBL_REPORT  AS UCR 
         ON UCR.REPORT_ID = SS.CREATED_BY 
         LEFT JOIN EMBCPROD.TBL_USER  AS UC 
         ON UCR.GLOBAL_REPORT_ID = UC.USER_ID AND UCR.STATUS IN ( 'A', 'D' ) 
         LEFT JOIN EMBCPROD.TBL_REPORT  AS UMR 
         ON UMR.REPORT_ID = SS.MODIFIED_BY 
         LEFT JOIN EMBCPROD.TBL_USER  AS UM 
         ON UM.USER_ID = UMR.GLOBAL_REPORT_ID AND UMR.STATUS IN ( 'A', 'D' ), 
      EMBCPROD.TBL_REPORT  AS REPT
   WHERE 
      REPT.REPORT_ID = SS.REPORT_ID AND 
      REPT.STATUS IN ( 'A', 'C', 'D' ) AND 
      REPT.REPORT_TYPE LIKE '%event%'
GO
EXECUTE sp_addextendedproperty @name = N'MS_SSMA_SOURCE', @value = N'EMBCPROD.V_EVENT_SITSUM', @level0type = N'SCHEMA', @level0name = N'EMBCPROD', @level1type = N'VIEW', @level1name = N'V_EVENT_SITSUM';

