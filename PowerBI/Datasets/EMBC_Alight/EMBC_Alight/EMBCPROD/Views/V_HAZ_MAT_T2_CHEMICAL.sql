CREATE VIEW EMBCPROD.V_HAZ_MAT_T2_CHEMICAL (
   UNIQUE_KEY, 
   PARENT_REPORT_UNIQUE_KEY, 
   HISTORY_VERSION, 
   DELETED, 
   FOREIGN_DOC, 
   CAS_NUMBER, 
   CHEMICAL_NAME, 
   TYPE, 
   TRADE_SECRET, 
   EHS, 
   EHS_NAME, 
   PHYSICAL_HAZARDS, 
   MAX_DAILY_AMOUNT, 
   AVG_DAILY_AMOUNT, 
   NUMBER_OF_DAYS_ON_SITE, 
   OPTIONAL_REPORT, 
   CONTAINER_TYPE, 
   TEMPERATURE, 
   PRESSURE, 
   STORAGE_LOCATIONS_REMARKS, 
   CREATION_DATE, 
   CREATED_BY, 
   MODIFICATION_DATE, 
   MODIFIED_BY)
AS 
   SELECT 
      HMC.HAZ_MAT_T2_CHEMICAL_ID AS UNIQUE_KEY, 
      HMC.HZ_PARENT_ID AS PARENT_REPORT_UNIQUE_KEY, 
      CASE HMC.STATUS
         WHEN 'O' THEN 'Yes'
         ELSE 'No'
      END AS HISTORY_VERSION, 
      CASE HMC.STATUS
         WHEN 'D' THEN 'Yes'
         ELSE 'No'
      END AS DELETED, 
      CASE HMC.CREATED_BY
         WHEN NULL THEN 'Yes'
         ELSE 'No'
      END AS FOREIGN_DOC, 
      HMC.HZ_CAS_NUMBER AS CAS_NUMBER, 
      HMC.HZ_CHEMICAL_NAME AS CHEMICAL_NAME, 
      HMC.HZ_TYPE AS TYPE, 
      HMC.HZ_TRADE_SECRET AS TRADE_SECRET, 
      HMC.HZ_EHS AS EHS, 
      HMC.HZ_EHS_NAME AS EHS_NAME, 
      HMC.HZ_PHYSICAL_HAZARDS AS PHYSICAL_HAZARDS, 
      HMC.HZ_MAX_DAILY_AMOUNT AS MAX_DAILY_AMOUNT, 
      HMC.HZ_AVG_DAILY_AMOUNT AS AVG_DAILY_AMOUNT, 
      HMC.HZ_NUMBER_OF_DAYS_ON_SITE AS NUMBER_OF_DAYS_ON_SITE, 
      HMC.HZ_OPTIONAL_REPORT AS OPTIONAL_REPORT, 
      HMC.HZ_CONTAINER_TYPE AS CONTAINER_TYPE, 
      HMC.HZ_TEMPERATURE AS TEMPERATURE, 
      HMC.HZ_PRESSURE AS PRESSURE, 
      HMC.HZ_STORAGE_LOCATIONS AS STORAGE_LOCATIONS_REMARKS, 
      HMC.CREATION_DATE, 
      CASE 
         WHEN UC.USER_NAME IS NULL THEN 
            (
               SELECT TBL_REMOTE_DOCUMENT_USER_INFO.CREATED_BY_USER_LOGIN_ID
               FROM EMBCPROD.TBL_REMOTE_DOCUMENT_USER_INFO
               WHERE TBL_REMOTE_DOCUMENT_USER_INFO.GLOBAL_REPORT_ID = HMC.HAZ_MAT_T2_CHEMICAL_ID
            )
         ELSE UC.USER_NAME
      END AS CREATED_BY, 
      HMC.MODIFICATION_DATE, 
      CASE 
         WHEN UM.USER_NAME IS NULL THEN 
            (
               SELECT TBL_REMOTE_DOCUMENT_USER_INFO$2.MODIFIED_BY_USER_LOGIN_ID
               FROM EMBCPROD.TBL_REMOTE_DOCUMENT_USER_INFO  AS TBL_REMOTE_DOCUMENT_USER_INFO$2
               WHERE TBL_REMOTE_DOCUMENT_USER_INFO$2.GLOBAL_REPORT_ID = HMC.HAZ_MAT_T2_CHEMICAL_ID
            )
         ELSE UM.USER_NAME
      END AS MODIFIED_BY
   FROM 
      EMBCPROD.TBL_HAZ_MAT_T2_CHEMICAL  AS HMC 
         LEFT JOIN EMBCPROD.TBL_REPORT  AS UCR 
         ON UCR.REPORT_ID = HMC.CREATED_BY 
         LEFT JOIN EMBCPROD.TBL_USER  AS UC 
         ON UCR.GLOBAL_REPORT_ID = UC.USER_ID AND UCR.STATUS IN ( 'A', 'D' ) 
         LEFT JOIN EMBCPROD.TBL_REPORT  AS UMR 
         ON UMR.REPORT_ID = HMC.MODIFIED_BY 
         LEFT JOIN EMBCPROD.TBL_USER  AS UM 
         ON UM.USER_ID = UMR.GLOBAL_REPORT_ID AND UMR.STATUS IN ( 'A', 'D' )
GO
EXECUTE sp_addextendedproperty @name = N'MS_SSMA_SOURCE', @value = N'EMBCPROD.V_HAZ_MAT_T2_CHEMICAL', @level0type = N'SCHEMA', @level0name = N'EMBCPROD', @level1type = N'VIEW', @level1name = N'V_HAZ_MAT_T2_CHEMICAL';

