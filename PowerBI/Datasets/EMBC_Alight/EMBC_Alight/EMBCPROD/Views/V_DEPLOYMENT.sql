CREATE VIEW EMBCPROD.V_DEPLOYMENT (
   VOLUNTEER_NAME, 
   RELATED_REPORT_NAME, 
   REPORT_VERSION, 
   DEPLOYMENT_ID, 
   DEPLOYMENT_STATUS, 
   LAST_NAME, 
   MIDDLE_INITIAL, 
   FIRST_NAME, 
   ORGANIZATION, 
   POSITION, 
   AGENCY, 
   ACTIVATION_DATE_TIME, 
   ARRIVAL_DATE_TIME, 
   JOB_ASSIGNMENT, 
   RELEASE_DATE_TIME, 
   DP_AIRPORT, 
   INCOMING_FLIGHT_INFO, 
   OUTGOING_FLIGHT_INFO, 
   VEHICLE_RENTAL, 
   ASSIGNED_VEHICLE, 
   SECURE_LODGING, 
   BILLING_FOR_LODGING, 
   BILLETING_INFO, 
   REPORT_TO_LOCATION, 
   PERSON_TO_CONTACT, 
   EMERGENCY_PHONE_FOR_TRAVEL, 
   OVERALL_PERFORMANCE, 
   EVALUATOR_COMMENTS, 
   INCIDENT_FILED, 
   INCIDENT_REPORT, 
   EVALUATOR_NAME, 
   EVALUATOR_ORGANIZATION, 
   EVALUATOR_POSITION, 
   EVALUATOR_AGENCY, 
   PARENT_REPORT_UNIQUE_KEY, 
   CREATION_DATE, 
   CREATED_BY, 
   MODIFICATION_DATE, 
   MODIFIED_BY)
AS 
   SELECT DISTINCT 
      ISNULL(V.VT_LAST_NAME, '') + ', ' + ISNULL(V.VT_FIRST_NAME, '') AS VOLUNTEER_NAME, 
      CASE RR.EIA_REPORT_TYPE
         WHEN 'emergency_event' THEN 'E - ' + ISNULL(RR.RELATED_REPORT_NAME, '')
         WHEN 'planned_event' THEN 'E - ' + ISNULL(RR.RELATED_REPORT_NAME, '')
         WHEN 'incident' THEN 'I - ' + ISNULL(RR.RELATED_REPORT_NAME, '')
         WHEN 'activity_center' THEN 'I - ' + ISNULL(RR.RELATED_REPORT_NAME, '')
         WHEN 'action_request' THEN 'A - ' + ISNULL(RR.RELATED_REPORT_NAME, '')
         WHEN 'plan_concern' THEN 'P - ' + ISNULL(RR.RELATED_REPORT_NAME, '')
         ELSE RR.RELATED_REPORT_NAME
      END AS RELATED_REPORT_NAME, 
      CASE REPT.STATUS
         WHEN 'O' THEN 'History'
         WHEN 'C' THEN 'Closed'
         WHEN 'D' THEN 'Deleted'
         WHEN 'A' THEN 'Active'
         WHEN 'R' THEN 'Restored'
         ELSE 'Not Known'
      END AS REPORT_VERSION, 
      DP.DEPLOYMENT_ID, 
      DP.DP_OPEN AS DEPLOYMENT_STATUS, 
      DP.DP_LAST_NAME AS LAST_NAME, 
      DP.DP_MIDDLE_INITIAL AS MIDDLE_INITIAL, 
      DP.DP_FIRST_NAME AS FIRST_NAME, 
      CASE 
         WHEN DP.DP_ORGANIZATION_MANUAL IS NULL THEN ORG.ORGANIZATION_NAME
         ELSE DP.DP_ORGANIZATION_MANUAL
      END AS ORGANIZATION, 
      CASE 
         WHEN DP.DP_POSITION_MANUAL IS NULL THEN POS.POSITION_NAME
         ELSE DP.DP_POSITION_MANUAL
      END AS POSITION, 
      DP.DP_AGENCY AS AGENCY, 
      DP.DP_ACTIVATION_DATE_TIME AS ACTIVATION_DATE_TIME, 
      DP.DP_ARRIVAL_DATE_TIME AS ARRIVAL_DATE_TIME, 
      DP.DP_JOB_ASSIGNMENT AS JOB_ASSIGNMENT, 
      DP.DP_RELEASE_DATE_TIME AS RELEASE_DATE_TIME, 
      DP.DP_AIRPORT, 
      ssma_oracle.dbms_lob$substr_clob(DP.DP_INCOMING_FLIGHT_INFO, 4000, 1) AS INCOMING_FLIGHT_INFO, 
      ssma_oracle.dbms_lob$substr_clob(DP.DP_OUTGOING_FLIGHT_INFO, 4000, 1) AS OUTGOING_FLIGHT_INFO, 
      DP.DP_IS_VEHICLE_RENTAL AS VEHICLE_RENTAL, 
      DP.DP_ASSIGNED_VEHICLE AS ASSIGNED_VEHICLE, 
      DP.DP_IS_SECURE_LODGING AS SECURE_LODGING, 
      DP.DP_IS_BILLING_FOR_LODGING AS BILLING_FOR_LODGING, 
      ssma_oracle.dbms_lob$substr_clob(DP.DP_BILLETING_INFO, 2500, 1) AS BILLETING_INFO, 
      ssma_oracle.dbms_lob$substr_clob(DP.DP_REPORT_TO_LOCATION, 2500, 1) AS REPORT_TO_LOCATION, 
      ssma_oracle.dbms_lob$substr_clob(DP.DP_PERSON_TO_CONTACT, 2500, 1) AS PERSON_TO_CONTACT, 
      DP.DP_EMERGENCY_PHONE_FOR_TRAVEL AS EMERGENCY_PHONE_FOR_TRAVEL, 
      DP.DP_OVERALL_PERFORMANCE AS OVERALL_PERFORMANCE, 
      ssma_oracle.dbms_lob$substr_clob(DP.DP_EVALUATOR_COMMENTS, 2500, 1) AS EVALUATOR_COMMENTS, 
      DP.DP_IS_INCIDENT_FILED AS INCIDENT_FILED, 
      ssma_oracle.dbms_lob$substr_clob(DP.DP_INCIDENT_REPORT, 2500, 1) AS INCIDENT_REPORT, 
      DP.DP_EVALUATOR_NAME AS EVALUATOR_NAME, 
      CASE 
         WHEN DP.DP_EVALUATOR_ORG_MANUAL IS NULL THEN DP.DP_EVALUATOR_ORGANIZATION_ID
         ELSE DP.DP_EVALUATOR_ORG_MANUAL
      END AS EVALUATOR_ORGANIZATION, 
      CASE 
         WHEN DP.DP_EVALUATOR_POSITION_MANUAL IS NULL THEN DP.DP_EVALUATOR_POSITION_ID
         ELSE DP.DP_EVALUATOR_POSITION_MANUAL
      END AS EVALUATOR_POSITION, 
      DP.DP_EVALUATOR_AGENCY AS EVALUATOR_AGENCY, 
      DP.DP_PARENT_ID AS PARENT_REPORT_UNIQUE_KEY, 
      REPT.CREATION_DATE, 
      CASE 
         WHEN UC.USER_NAME IS NULL THEN 
            (
               SELECT TBL_REMOTE_DOCUMENT_USER_INFO.CREATED_BY_USER_LOGIN_ID
               FROM EMBCPROD.TBL_REMOTE_DOCUMENT_USER_INFO
               WHERE TBL_REMOTE_DOCUMENT_USER_INFO.GLOBAL_REPORT_ID = DP.DEPLOYMENT_ID
            )
         ELSE UC.USER_NAME
      END AS CREATED_BY, 
      REPT.MODIFICATION_DATE, 
      CASE 
         WHEN UM.USER_NAME IS NULL THEN 
            (
               SELECT TBL_REMOTE_DOCUMENT_USER_INFO$2.MODIFIED_BY_USER_LOGIN_ID
               FROM EMBCPROD.TBL_REMOTE_DOCUMENT_USER_INFO  AS TBL_REMOTE_DOCUMENT_USER_INFO$2
               WHERE TBL_REMOTE_DOCUMENT_USER_INFO$2.GLOBAL_REPORT_ID = DP.DEPLOYMENT_ID
            )
         ELSE UM.USER_NAME
      END AS MODIFIED_BY
   FROM 
      EMBCPROD.TBL_REPORT  AS REPT 
         LEFT JOIN EMBCPROD.TBL_RELATED_REPORT  AS RR 
         ON REPT.GLOBAL_REPORT_ID = RR.GLOBAL_REPORT_ID AND RR.RELATED_REPORT_TYPE = 'EIA' 
         LEFT JOIN EMBCPROD.TBL_REPORT  AS UCR 
         ON UCR.REPORT_ID = REPT.CREATED_BY 
         LEFT JOIN EMBCPROD.TBL_USER  AS UC 
         ON UCR.GLOBAL_REPORT_ID = UC.USER_ID AND UCR.STATUS IN ( 'A', 'D' ) 
         LEFT JOIN EMBCPROD.TBL_REPORT  AS UMR 
         ON UMR.REPORT_ID = REPT.MODIFIED_BY 
         LEFT JOIN EMBCPROD.TBL_USER  AS UM 
         ON UM.USER_ID = UMR.GLOBAL_REPORT_ID AND UMR.STATUS IN ( 'A', 'D' ), 
      EMBCPROD.TBL_DEPLOYMENT  AS DP 
         LEFT JOIN EMBCPROD.TBL_ORGANIZATION  AS ORG 
         ON DP.DP_ORGANIZATION_ID = ORG.ORGANIZATION_ID 
         LEFT JOIN EMBCPROD.TBL_ORGANIZATION_POSITIONS  AS POS 
         ON DP.DP_POSITION_ID = POS.POSITION_ID 
         LEFT JOIN EMBCPROD.TBL_VOLUNTEER  AS V 
         ON V.VOLUNTEER_ID = DP.DP_PARENT_ID
   WHERE REPT.GLOBAL_REPORT_ID = DP.DEPLOYMENT_ID AND RR.RELATED_GLOBAL_REPORT_ID IN 
      (
         SELECT TBL_REPORT.GLOBAL_REPORT_ID
         FROM EMBCPROD.TBL_REPORT
         WHERE TBL_REPORT.STATUS IN ( 'A', 'C', 'D' )
      )
GO
EXECUTE sp_addextendedproperty @name = N'MS_SSMA_SOURCE', @value = N'EMBCPROD.V_DEPLOYMENT', @level0type = N'SCHEMA', @level0name = N'EMBCPROD', @level1type = N'VIEW', @level1name = N'V_DEPLOYMENT';

