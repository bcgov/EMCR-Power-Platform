CREATE VIEW EMBCPROD.V_PERSONAL_PROFILE (
   USER_NAME, 
   USERNAME_STATUS, 
   LOGIN_TIME, 
   UNIQUE_KEY, 
   REPORT_VERSION, 
   OWNED_BY, 
   FIRST_NAME, 
   LAST_NAME, 
   ORGANIZATION, 
   POSITION, 
   AGENCY, 
   PHONE, 
   FAX, 
   PAGER, 
   CELL, 
   EMAIL, 
   OTHER, 
   CREATION_DATE, 
   MODIFICATION_DATE, 
   VIEW_CREATED_ON)
AS 
   SELECT 
      U.USER_NAME, 
      UREPT.STATUS AS USERNAME_STATUS, 
      EMBCPROD.GET_LOGIN_TIME(U.USER_ID, REPT.STATUS) AS LOGIN_TIME, 
      PP.PROFILE_ID AS UNIQUE_KEY, 
      CASE REPT.STATUS
         WHEN 'O' THEN 'History'
         WHEN 'C' THEN 'Closed'
         WHEN 'D' THEN 'Deleted'
         WHEN 'A' THEN 'Active'
         WHEN 'R' THEN 'Restored'
         ELSE 'Not Known'
      END AS REPORT_VERSION, 
      CASE REPT.IS_OWNER
         WHEN 'Y' THEN 'Local'
         ELSE 'No'
      END AS OWNED_BY, 
      PP.FIRST_NAME, 
      PP.LAST_NAME, 
      PP.ORG_LOCATION AS ORGANIZATION, 
      PP.POSITION, 
      PP.AGENCY, 
      PP.PHONE, 
      PP.FAX, 
      PP.PAGER, 
      PP.CELL, 
      PP.EMAIL, 
      PP.OTHER, 
      REPT.CREATION_DATE, 
      REPT.MODIFICATION_DATE, 
      '30_04_2012' AS VIEW_CREATED_ON
   FROM 
      EMBCPROD.TBL_PERSONAL_PROFILE  AS PP, 
      EMBCPROD.TBL_REPORT  AS REPT 
         LEFT JOIN EMBCPROD.TBL_USER  AS U 
         ON U.PROFILE_ID = REPT.REPORT_ID 
         LEFT JOIN EMBCPROD.TBL_REPORT  AS UREPT 
         ON U.USER_ID = UREPT.GLOBAL_REPORT_ID 
         LEFT JOIN EMBCPROD.TBL_ACTIVE_USER  AS AU 
         ON U.USER_ID = AU.USER_ID
   WHERE REPT.GLOBAL_REPORT_ID = PP.PROFILE_ID
GO
EXECUTE sp_addextendedproperty @name = N'MS_SSMA_SOURCE', @value = N'EMBCPROD.V_PERSONAL_PROFILE', @level0type = N'SCHEMA', @level0name = N'EMBCPROD', @level1type = N'VIEW', @level1name = N'V_PERSONAL_PROFILE';

