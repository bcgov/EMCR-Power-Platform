CREATE VIEW EMBCPROD.V_AGENCY_SITREP (
   UNIQUE_KEY, 
   HISTORY_VERSION, 
   DELETED, 
   FOREIGN_DOC, 
   WEB_PAGE_LINK, 
   DATASHARE_COMMENTS, 
   OWNED_BY, 
   AGENCY, 
   JURISDICTION_NAME, 
   READINESS, 
   CITY, 
   COUNTY_NAME, 
   STATE_NAME, 
   CURRENT_OBJECTIVES, 
   PROJECTED_OBJECTIVES, 
   CONCERNS_PROBLEMS, 
   IS_CENTER_ACTIVE, 
   CENTER_ACTIVE_DURATION, 
   RESPONDERS_AVAIL, 
   RESPONDERS_MISSION_CAP, 
   ADMIN_STAFF__AVAIL, 
   ADMIN_STAFF_MISSION_CAP, 
   FACILITIES_AVAIL, 
   FACILTIES_MISSION_CAP, 
   COMMUNICATION_AVAIL, 
   COMMUNICATION_MISSION_CAP, 
   CONSUMABLES_AVAIL, 
   CONSUMABLES_MISSION_CAP, 
   VEHICES_AVAIL, 
   VAHICLES_MISSION_CAP, 
   RELATED_REPORT_NAME, 
   CAT_A_NO_OF_SITES, 
   CAT_A_NO_OF_SITES_INT, 
   CAT_A_ESTIMATED_LOSS, 
   CAT_A_ESTIMATED_LOSS_FL, 
   CAT_B_NO_OF_SITES, 
   CAT_B_NO_OF_SITES_INT, 
   CAT_B_ESTIMATED_LOSS, 
   CAT_B_ESTIMATED_LOSS_FL, 
   CAT_C_NO_OF_SITES, 
   CAT_C_NO_OF_SITES_INT, 
   CAT_C_ESTIMATED_LOSS, 
   CAT_C_ESTIMATED_LOSS_FL, 
   CAT_D_NO_OF_SITES, 
   CAT_D_NO_OF_SITES_INT, 
   CAT_D_ESTIMATED_LOSS, 
   CAT_D_ESTIMATED_LOSS_FL, 
   CAT_E_NO_OF_SITES, 
   CAT_E_NO_OF_SITES_INT, 
   CAT_E_ESTIMATED_LOSS, 
   CAT_E_ESTIMATED_LOSS_FL, 
   CAT_F_NO_OF_SITES, 
   CAT_F_NO_OF_SITES_INT, 
   CAT_F_ESTIMATED_LOSS, 
   CAT_F_ESTIMATED_LOSS_FL, 
   CAT_G_NO_OF_SITES, 
   CAT_G_NO_OF_SITES_INT, 
   CAT_G_ESTIMATED_LOSS, 
   CAT_G_ESTIMATED_LOSS_FL, 
   TOTAL_NO_OF_SITES, 
   TOTAL_ESTIMATED_LOSS, 
   RESOURCE_TYPE_1, 
   RESOURCE_TYPE_1_DEP, 
   RESOURCE_TYPE_1_DEP_INT, 
   RESOURCE_TYPE_1_AVAIL, 
   RESOURCE_TYPE_1_AVAIL_INT, 
   RESOURCE_TYPE_2, 
   RESOURCE_TYPE_2_DEP, 
   RESOURCE_TYPE_2_DEP_INT, 
   RESOURCE_TYPE_2_AVAIL, 
   RESOURCE_TYPE_2_AVAIL_INT, 
   RESOURCE_TYPE_3, 
   RESOURCE_TYPE_3_DEP, 
   RESOURCE_TYPE_3_DEP_INT, 
   RESOURCE_TYPE_3_AVAIL, 
   RESOURCE_TYPE_3_AVAIL_INT, 
   RESOURCE_TYPE_4, 
   RESOURCE_TYPE_4_DEP, 
   RESOURCE_TYPE_4_DEP_INT, 
   RESOURCE_TYPE_4_AVAIL, 
   RESOURCE_TYPE_4_AVAIL_INT, 
   RESOURCE_TYPE_5, 
   RESOURCE_TYPE_5_DEP, 
   RESOURCE_TYPE_5_DEP_INT, 
   RESOURCE_TYPE_5_AVAIL, 
   RESOURCE_TYPE_5_AVAIL_INT, 
   CREATION_DATE, 
   CREATED_BY, 
   MODIFICATION_DATE, 
   MODIFIED_BY, 
   TIMEZONE)
AS 
   /*
   *   SSMA warning messages:
   *   O2SS0273: Oracle SUBSTR function and SQL Server SUBSTRING function may give different results.
   */

   SELECT 
      A.AGENCY_REPORT_ID AS UNIQUE_KEY, 
      CASE REPT.STATUS
         WHEN 'O' THEN 'Yes'
         ELSE 'No'
      END AS HISTORY_VERSION, 
      CASE REPT.STATUS
         WHEN 'D' THEN 'Yes'
         ELSE 'No'
      END AS DELETED, 
      CASE REPT.CREATED_BY
         WHEN NULL THEN 'Yes'
         ELSE 'No'
      END AS FOREIGN_DOC, 
      REPT.WEB_PAGE_LINK, 
      DS.COMMENTS AS DATASHARE_COMMENTS, 
      CASE REPT.IS_OWNER
         WHEN 'Y' THEN 'Local'
         ELSE 'No'
      END AS OWNED_BY, 
      A.AGENCY, 
      A.JURISDICTION_NAME, 
      ISNULL(upper(substring(PV.COLOR_IMG_KEY, 7, (ssma_oracle.instr4_varchar(PV.COLOR_IMG_KEY, '.', 7, 1) - 7))), '') + ' - ' + ISNULL(PV.PICKLIST_VALUE, '') AS READINESS, 
      A.CITY, 
      A.COUNTY_NAME, 
      A.STATE_NAME, 
      A.CURRENT_OBJECTIVES, 
      A.PROJECTED_OBJECTIVES, 
      A.CONCERNS_PROBLEMS, 
      A.IS_CENTER_ACTIVE, 
      A.CENTER_ACTIVE_DURATION, 
      A.RESPONDERS_AVAIL, 
      A.RESPONDERS_MISSION_CAP, 
      A.ADMIN_STAFF__AVAIL, 
      A.ADMIN_STAFF_MISSION_CAP, 
      A.FACILITIES_AVAIL, 
      A.FACILTIES_MISSION_CAP, 
      A.COMMUNICATION_AVAIL, 
      A.COMMUNICATION_MISSION_CAP, 
      A.CONSUMABLES_AVAIL, 
      A.CONSUMABLES_MISSION_CAP, 
      A.VEHICES_AVAIL, 
      A.VAHICLES_MISSION_CAP, 
      RR.RELATED_REPORT_NAME, 
      A.CAT_A_NO_OF_SITES, 
      CAST(A.CAT_A_NO_OF_SITES AS int) AS CAT_A_NO_OF_SITES_INT, 
      A.CAT_A_ESTIMATED_LOSS, 
      CAST(A.CAT_A_ESTIMATED_LOSS AS float(53)) AS CAT_A_ESTIMATED_LOSS_FL, 
      A.CAT_B_NO_OF_SITES, 
      CAST(A.CAT_B_NO_OF_SITES AS int) AS CAT_B_NO_OF_SITES_INT, 
      A.CAT_B_ESTIMATED_LOSS, 
      CAST(A.CAT_B_ESTIMATED_LOSS AS float(53)) AS CAT_B_ESTIMATED_LOSS_FL, 
      A.CAT_C_NO_OF_SITES, 
      CAST(A.CAT_C_NO_OF_SITES AS int) AS CAT_C_NO_OF_SITES_INT, 
      A.CAT_C_ESTIMATED_LOSS, 
      CAST(A.CAT_C_ESTIMATED_LOSS AS float(53)) AS CAT_C_ESTIMATED_LOSS_FL, 
      A.CAT_D_NO_OF_SITES, 
      CAST(A.CAT_D_NO_OF_SITES AS int) AS CAT_D_NO_OF_SITES_INT, 
      A.CAT_D_ESTIMATED_LOSS, 
      CAST(A.CAT_D_ESTIMATED_LOSS AS float(53)) AS CAT_D_ESTIMATED_LOSS_FL, 
      A.CAT_E_NO_OF_SITES, 
      CAST(A.CAT_E_NO_OF_SITES AS int) AS CAT_E_NO_OF_SITES_INT, 
      A.CAT_E_ESTIMATED_LOSS, 
      CAST(A.CAT_E_ESTIMATED_LOSS AS float(53)) AS CAT_E_ESTIMATED_LOSS_FL, 
      A.CAT_F_NO_OF_SITES, 
      CAST(A.CAT_F_NO_OF_SITES AS int) AS CAT_F_NO_OF_SITES_INT, 
      A.CAT_F_ESTIMATED_LOSS, 
      CAST(A.CAT_F_ESTIMATED_LOSS AS float(53)) AS CAT_F_ESTIMATED_LOSS_FL, 
      A.CAT_G_NO_OF_SITES, 
      CAST(A.CAT_G_NO_OF_SITES AS int) AS CAT_G_NO_OF_SITES_INT, 
      A.CAT_G_ESTIMATED_LOSS, 
      CAST(A.CAT_G_ESTIMATED_LOSS AS float(53)) AS CAT_G_ESTIMATED_LOSS_FL, 
      (
         CAST(replace(CAST(A.CAT_A_NO_OF_SITES AS varchar(max)), ',', NULL) AS numeric(38, 10))
          + 
         CAST(replace(CAST(A.CAT_B_NO_OF_SITES AS varchar(max)), ',', NULL) AS numeric(38, 10))
          + 
         CAST(replace(CAST(A.CAT_C_NO_OF_SITES AS varchar(max)), ',', NULL) AS numeric(38, 10))
          + 
         CAST(replace(CAST(A.CAT_D_NO_OF_SITES AS varchar(max)), ',', NULL) AS numeric(38, 10))
          + 
         CAST(replace(CAST(A.CAT_E_NO_OF_SITES AS varchar(max)), ',', NULL) AS numeric(38, 10))
          + 
         CAST(replace(CAST(A.CAT_F_NO_OF_SITES AS varchar(max)), ',', NULL) AS numeric(38, 10))
          + 
         CAST(replace(CAST(A.CAT_G_NO_OF_SITES AS varchar(max)), ',', NULL) AS numeric(38, 10))) AS TOTAL_NO_OF_SITES, 
      (
         CAST(replace(CAST(A.CAT_A_ESTIMATED_LOSS AS varchar(max)), ',', NULL) AS numeric(38, 10))
          + 
         CAST(replace(CAST(A.CAT_B_ESTIMATED_LOSS AS varchar(max)), ',', NULL) AS numeric(38, 10))
          + 
         CAST(replace(CAST(A.CAT_C_ESTIMATED_LOSS AS varchar(max)), ',', NULL) AS numeric(38, 10))
          + 
         CAST(replace(CAST(A.CAT_D_ESTIMATED_LOSS AS varchar(max)), ',', NULL) AS numeric(38, 10))
          + 
         CAST(replace(CAST(A.CAT_E_ESTIMATED_LOSS AS varchar(max)), ',', NULL) AS numeric(38, 10))
          + 
         CAST(replace(CAST(A.CAT_F_ESTIMATED_LOSS AS varchar(max)), ',', NULL) AS numeric(38, 10))
          + 
         CAST(replace(CAST(A.CAT_G_ESTIMATED_LOSS AS varchar(max)), ',', NULL) AS numeric(38, 10))) AS TOTAL_ESTIMATED_LOSS, 
      A.RESOURCE_TYPE_1, 
      A.RESOURCE_TYPE_1_DEP, 
      CAST(A.RESOURCE_TYPE_1_DEP AS int) AS RESOURCE_TYPE_1_DEP_INT, 
      A.RESOURCE_TYPE_1_AVAIL, 
      CAST(A.RESOURCE_TYPE_1_AVAIL AS int) AS RESOURCE_TYPE_1_AVAIL_INT, 
      A.RESOURCE_TYPE_2, 
      A.RESOURCE_TYPE_2_DEP, 
      CAST(A.RESOURCE_TYPE_2_DEP AS int) AS RESOURCE_TYPE_2_DEP_INT, 
      A.RESOURCE_TYPE_2_AVAIL, 
      CAST(A.RESOURCE_TYPE_2_AVAIL AS int) AS RESOURCE_TYPE_2_AVAIL_INT, 
      A.RESOURCE_TYPE_3, 
      A.RESOURCE_TYPE_3_DEP, 
      CAST(A.RESOURCE_TYPE_3_DEP AS int) AS RESOURCE_TYPE_3_DEP_INT, 
      A.RESOURCE_TYPE_3_AVAIL, 
      CAST(A.RESOURCE_TYPE_3_AVAIL AS int) AS RESOURCE_TYPE_3_AVAIL_INT, 
      A.RESOURCE_TYPE_4, 
      A.RESOURCE_TYPE_4_DEP, 
      CAST(A.RESOURCE_TYPE_4_DEP AS int) AS RESOURCE_TYPE_4_DEP_INT, 
      A.RESOURCE_TYPE_4_AVAIL, 
      CAST(A.RESOURCE_TYPE_4_AVAIL AS int) AS RESOURCE_TYPE_4_AVAIL_INT, 
      A.RESOURCE_TYPE_5, 
      A.RESOURCE_TYPE_5_DEP, 
      CAST(A.RESOURCE_TYPE_5_DEP AS int) AS RESOURCE_TYPE_5_DEP_INT, 
      A.RESOURCE_TYPE_5_AVAIL, 
      CAST(A.RESOURCE_TYPE_5_AVAIL AS int) AS RESOURCE_TYPE_5_AVAIL_INT, 
      REPT.CREATION_DATE, 
      CASE 
         WHEN UC.USER_NAME IS NULL THEN 
            (
               SELECT TBL_REMOTE_DOCUMENT_USER_INFO.CREATED_BY_USER_LOGIN_ID
               FROM EMBCPROD.TBL_REMOTE_DOCUMENT_USER_INFO
               WHERE TBL_REMOTE_DOCUMENT_USER_INFO.GLOBAL_REPORT_ID = A.AGENCY_REPORT_ID
            )
         ELSE UC.USER_NAME
      END AS CREATED_BY, 
      REPT.MODIFICATION_DATE, 
      CASE 
         WHEN UM.USER_NAME IS NULL THEN 
            (
               SELECT TBL_REMOTE_DOCUMENT_USER_INFO$2.MODIFIED_BY_USER_LOGIN_ID
               FROM EMBCPROD.TBL_REMOTE_DOCUMENT_USER_INFO  AS TBL_REMOTE_DOCUMENT_USER_INFO$2
               WHERE TBL_REMOTE_DOCUMENT_USER_INFO$2.GLOBAL_REPORT_ID = A.AGENCY_REPORT_ID
            )
         ELSE UM.USER_NAME
      END AS MODIFIED_BY, 
      
         (
            SELECT TBL_EEMS_CONFIGURATION.CUSTOMER_TIMEZONE
            FROM EMBCPROD.TBL_EEMS_CONFIGURATION, EMBCPROD.TBL_REPORT
            WHERE TBL_EEMS_CONFIGURATION.CONFIGURATION_ID = TBL_REPORT.GLOBAL_REPORT_ID AND TBL_REPORT.STATUS = 'A'
         ) AS TIMEZONE
   FROM 
      EMBCPROD.TBL_AGENCY_SITE_REPORT  AS A 
         LEFT JOIN EMBCPROD.TBL_PICKLIST_VALUE  AS PV 
         ON A.READINESS = PV.PICKLIST_VALUE_ID, 
      ((((EMBCPROD.TBL_REPORT  AS REPT 
         LEFT JOIN EMBCPROD.TBL_LOCATION  AS L 
         ON REPT.LOCATION_ID = L.LOCATION_ID) 
         LEFT JOIN EMBCPROD.TBL_GEO_LOCATION_MAPPING  AS G 
         ON REPT.GEO_LOCATION_MAPPING_ID = G.GEO_LOCATION_MAPPING_ID) 
         LEFT JOIN EMBCPROD.TBL_RESPONSIBLE_ENTITY  AS RE 
         ON REPT.ENTITY_ID = RE.ENTITY_ID) 
         LEFT JOIN EMBCPROD.TBL_DATA_SHARING  AS DS 
         ON REPT.DATA_SHARING_ID = DS.DATA_SHARING_ID) 
         LEFT JOIN EMBCPROD.TBL_RELATED_REPORT  AS RR 
         ON 
            REPT.GLOBAL_REPORT_ID = RR.GLOBAL_REPORT_ID AND 
            RR.RELATED_REPORT_TYPE = 'EIA' AND 
            RR.RELATED_GLOBAL_REPORT_ID IN 
            (
               SELECT TBL_REPORT$2.GLOBAL_REPORT_ID
               FROM EMBCPROD.TBL_REPORT  AS TBL_REPORT$2
               WHERE TBL_REPORT$2.STATUS IN ( 'A', 'C', 'D' )
            ) 
         LEFT JOIN EMBCPROD.TBL_REPORT  AS UCR 
         ON UCR.REPORT_ID = REPT.CREATED_BY 
         LEFT JOIN EMBCPROD.TBL_USER  AS UC 
         ON UCR.GLOBAL_REPORT_ID = UC.USER_ID AND UCR.STATUS IN ( 'A', 'D' ) 
         LEFT JOIN EMBCPROD.TBL_REPORT  AS UMR 
         ON UMR.REPORT_ID = REPT.MODIFIED_BY 
         LEFT JOIN EMBCPROD.TBL_USER  AS UM 
         ON UM.USER_ID = UMR.GLOBAL_REPORT_ID AND UMR.STATUS IN ( 'A', 'D' )
   WHERE A.AGENCY_REPORT_ID = REPT.GLOBAL_REPORT_ID
GO
EXECUTE sp_addextendedproperty @name = N'MS_SSMA_SOURCE', @value = N'EMBCPROD.V_AGENCY_SITREP', @level0type = N'SCHEMA', @level0name = N'EMBCPROD', @level1type = N'VIEW', @level1name = N'V_AGENCY_SITREP';

