
CREATE VIEW [EMBCPROD].[V_MEDICAL_HEALTH] (
   PARENT_KEY, 
   UNIQUE_KEY, 
   HISTORY_VERSION, 
   DELETED, 
   FOREIGN_DOC, 
   OWNED_BY, 
   FORM_TYPE, 
   FIELD_SITES, 
   WATER_SYSTEM_AFFECTED, 
   WATER_SYSTEM_DESCRIPTION, 
   FOOD_CONTAMINATED, 
   FOOD_CONTAMINATED_COMMENT, 
   SEWAGE_PROBLEMS, 
   SEWAGE_PROBLEMS_DESC, 
   AREA_QUARANTINED, 
   AREA_QUARANTINED_DESC, 
   ANIMAL_CONTROLLED_PROB, 
   ANIMAL_CONTROLLED_PROB_DESC, 
   INFECTIOUS_DISEASE, 
   INFECTIOUS_DISEASE_DESC, 
   MENTAL_HEALTH_ISSUES, 
   MENTAL_HEALTH_ISSUES_DESC, 
   HAZMAT_ISSUES, 
   HAZMAT_ISSUES_DESC, 
   EVACUATION_ISSUES, 
   EVACUATION_ISSUES_DESC, 
   SHELTER_ISSUES, 
   SHELTER_ISSUES_DESC, 
   CREATION_DATE, 
   CREATED_BY, 
   MODIFICATION_DATE, 
   MODIFIED_BY, 
   TIMEZONE)
AS 
   SELECT 
      REPT.REPORT_ID AS PARENT_KEY, 
      M.MEDICAL_HEALTH_ID AS UNIQUE_KEY, 
      CASE M.STATUS
         WHEN 'O' THEN 'Yes'
         ELSE 'No'
      END AS HISTORY_VERSION, 
      CASE REPT.STATUS
         WHEN 'D' THEN 'Yes'
         ELSE 'No'
      END AS DELETED, 
      CASE M.CREATED_BY
         WHEN NULL THEN 'Yes'
         ELSE 'No'
      END AS FOREIGN_DOC, 
      CASE REPT.IS_OWNER
         WHEN 'Y' THEN 'Local'
         ELSE 'No'
      END AS OWNED_BY, 
      'Medical Health' AS FORM_TYPE, 
      M.FIELD_SITES, 
      M.WATER_SYSTEM_AFFECTED, 
      M.WATER_SYSTEM_DESCRIPTION, 
      M.FOOD_CONTAMINATED, 
      M.FOOD_CONTAMINATED_COMMENT, 
      M.SEWAGE_PROBLEMS, 
      M.SEWAGE_PROBLEMS_DESC, 
      M.AREA_QUARANTINED, 
      M.AREA_QUARANTINED_DESC, 
      M.ANIMAL_CONTROLLED_PROB, 
      M.ANIMAL_CONTROLLED_PROB_DESC, 
      M.INFECTIOUS_DISEASE, 
      M.INFECTIOUS_DISEASE_DESC, 
      M.MENTAL_HEALTH_ISSUES, 
      M.MENTAL_HEALTH_ISSUES_DESC, 
      M.HAZMAT_ISSUES, 
      M.HAZMAT_ISSUES_DESC, 
      M.EVACUATION_ISSUES, 
      M.EVACUATION_ISSUES_DESC, 
      M.SHELTER_ISSUES, 
      M.SHELTER_ISSUES_DESC, 
      M.CREATION_DATE, 
      CASE 
         WHEN UC.USER_NAME IS NULL THEN 
            (
               SELECT TBL_REMOTE_DOCUMENT_USER_INFO.CREATED_BY_USER_LOGIN_ID
               FROM EMBCPROD.TBL_REMOTE_DOCUMENT_USER_INFO
               WHERE TBL_REMOTE_DOCUMENT_USER_INFO.GLOBAL_REPORT_ID = M.GLOBAL_MEDICAL_HEALTH_ID
            )
         ELSE UC.USER_NAME
      END AS CREATED_BY, 
      M.MODIFICATION_DATE, 
      CASE 
         WHEN UM.USER_NAME IS NULL THEN 
            (
               SELECT TBL_REMOTE_DOCUMENT_USER_INFO$2.MODIFIED_BY_USER_LOGIN_ID
               FROM EMBCPROD.TBL_REMOTE_DOCUMENT_USER_INFO  AS TBL_REMOTE_DOCUMENT_USER_INFO$2
               WHERE TBL_REMOTE_DOCUMENT_USER_INFO$2.GLOBAL_REPORT_ID = M.GLOBAL_MEDICAL_HEALTH_ID
            )
         ELSE UM.USER_NAME
      END AS MODIFIED_BY, 
      
         (
            SELECT TBL_EEMS_CONFIGURATION.CUSTOMER_TIMEZONE
            FROM EMBCPROD.TBL_EEMS_CONFIGURATION, EMBCPROD.TBL_REPORT
            WHERE TBL_EEMS_CONFIGURATION.CONFIGURATION_ID = TBL_REPORT.GLOBAL_REPORT_ID AND TBL_REPORT.STATUS = 'A'
         ) AS TIMEZONE
   FROM 
      EMBCPROD.TBL_REPORT  AS REPT, 
      EMBCPROD.TBL_INCIDENT  AS I 
         LEFT JOIN EMBCPROD.TBL_INCIDENT_MEDICAL_HEALTH  AS M 
         ON I.MEDICAL_HEALTH_ID = M.GLOBAL_MEDICAL_HEALTH_ID 
         LEFT JOIN EMBCPROD.TBL_REPORT  AS UCR 
         ON UCR.REPORT_ID = M.CREATED_BY 
         LEFT JOIN EMBCPROD.TBL_USER  AS UC 
         ON UCR.GLOBAL_REPORT_ID = UC.USER_ID AND UCR.STATUS IN ( 'A', 'D' ) 
         LEFT JOIN EMBCPROD.TBL_REPORT  AS UMR 
         ON UMR.REPORT_ID = M.MODIFIED_BY 
         LEFT JOIN EMBCPROD.TBL_USER  AS UM 
         ON UM.USER_ID = UMR.GLOBAL_REPORT_ID AND UMR.STATUS IN ( 'A', 'D' )
   WHERE I.INCIDENT_ID = REPT.GLOBAL_REPORT_ID AND M.MEDICAL_HEALTH_ID IS NOT NULL

GO
EXECUTE sp_addextendedproperty @name = N'MS_SSMA_SOURCE', @value = N'EMBCPROD.V_MEDICAL_HEALTH', @level0type = N'SCHEMA', @level0name = N'EMBCPROD', @level1type = N'VIEW', @level1name = N'V_MEDICAL_HEALTH';

