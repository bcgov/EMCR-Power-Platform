
CREATE VIEW [EMBCPROD].[V_JURIS_SITREP] (
   UNIQUE_KEY, 
   HISTORY_VERSION, 
   DELETED, 
   FOREIGN_DOC, 
   WEB_PAGE_LINK, 
   DATASHARE_COMMENTS, 
   OWNED_BY, 
   JURISDICTION_NAME, 
   STATUS, 
   CITY, 
   COUNTY_NAME, 
   STATE_NAME, 
   CURRENT_OBJECTIVES, 
   PROJECTED_OBJECTIVES, 
   CONCERNS_PROBLEMS, 
   RELATED_REPORT_NAME, 
   DATE_REQUESTED_LOCAL, 
   DATE_REQUESTED_INTERMEDIATE, 
   DATE_REQUESTED_GUBERNATORIAL, 
   DATE_REQUESTED_PRESIDENTIAL, 
   DATE_GRANTED_LOCAL, 
   DATE_GRANTED_INTERMEDIATE, 
   DATE_GRANTED_GUBERNATORIAL, 
   DATE_GRANTED_PRESIDENTIAL, 
   INTERMEDIATE_LEVEL, 
   ESTIMATED_FATALITIES, 
   ESTIMATED_FATALITIES_INT, 
   CONFIRMED_FATALITIES, 
   CONFIRMED_FATALITIES_INT, 
   FATALITIES_COMMENT, 
   ESTIMATED_INJURIES, 
   ESTIMATED_INJURIES_INT, 
   CONFIRMED_INJURIES, 
   CONFIRMED_INJURIES_INT, 
   INJURIES_COMMENT, 
   RESIDENCES_DESTROYED, 
   RESIDENCES_DESTROYED_INT, 
   RESIDENCE_MAJOR, 
   RESIDENCE_MAJOR_INT, 
   RESIDENCES_MINOR, 
   RESIDENCES_MINOR_INT, 
   RESIDENCES_AFFECTED, 
   RESIDENCES_AFFECTED_INT, 
   RESIDENCES_ESTIMATED_COST, 
   RESIDENCES_ESTIMATED_COST_FL, 
   RESIDENCES_INSURED, 
   RESIDENCES_INSURED_FL, 
   BUSINESS_DESTROYED, 
   BUSINESS_DESTROYED_INT, 
   BUSINESS_MAJOR, 
   BUSINESS_MAJOR_INT, 
   BUSINESS_MINOR, 
   BUSINESS_MINOR_INT, 
   BUSINESS_AFFECTED, 
   BUSINESS_AFFECTED_INT, 
   BUSINESS_ESTIMATED_COST, 
   BUSINESS_ESTIMATED_COST_FL, 
   BUSINESS_INSURED, 
   BUSINESS_INSURED_FL, 
   GOVERNMENT_DESTROYED, 
   GOVERNMENT_DESTROYED_INT, 
   GOVERNMENT_MAJOR, 
   GOVERNMENT_MAJOR_INT, 
   GOVERNMENT_MINOR, 
   GOVERNMENT_MINOR_INT, 
   GOVERNMENT_AFFECTED, 
   GOVERNMENT_AFFECTED_INT, 
   GOVERNMENT_ESTIMATED_COST, 
   GOVERNMENT_ESTIMATED_COST_FL, 
   GOVERNMENT_INSURED, 
   GOVERNMENT_INSURED_FL, 
   TOTAL_ESTIMATED_COST, 
   CAT_A_NO_OF_SITES, 
   CAT_A_NO_OF_SITES_INT, 
   CAT_A_ESTIMATED_LOSS, 
   CAT_A_ESTIMATED_LOSS_FL, 
   CAT_B_NO_OF_SITES, 
   CAT_B_NO_OF_SITES_INT, 
   CAT_B_ESTIMATED_LOSS, 
   CAT_B_ESTIMATED_LOSS_FL, 
   CAT_C_NO_OF_SITES, 
   CAT_C_NO_OF_SITES_INT, 
   CAT_C_ESTIMATED_LOSS, 
   CAT_C_ESTIMATED_LOSS_FL, 
   CAT_D_NO_OF_SITES, 
   CAT_D_NO_OF_SITES_INT, 
   CAT_D_ESTIMATED_LOSS, 
   CAT_D_ESTIMATED_LOSS_FL, 
   CAT_E_NO_OF_SITES, 
   CAT_E_NO_OF_SITES_INT, 
   CAT_E_ESTIMATED_LOSS, 
   CAT_E_ESTIMATED_LOSS_FL, 
   CAT_F_NO_OF_SITES, 
   CAT_F_NO_OF_SITES_INT, 
   CAT_F_ESTIMATED_LOSS, 
   CAT_F_ESTIMATED_LOSS_FL, 
   CAT_G_NO_OF_SITES, 
   CAT_G_NO_OF_SITES_INT, 
   CAT_G_ESTIMATED_LOSS, 
   CAT_G_ESTIMATED_LOSS_FL, 
   TOTAL_NO_OF_SITES, 
   TOTAL_ESTIMATED_LOSS, 
   PEOPLE_EVACUATED, 
   PEOPLE_EVACUATED_INT, 
   PEOPLE_IN_SHELTERS, 
   PEOPLE_IN_SHELTERS_INT, 
   COMMENTS, 
   ADDITIONAL_COMMENTS, 
   CREATION_DATE, 
   CREATED_BY, 
   MODIFICATION_DATE, 
   MODIFIED_BY, 
   TIMEZONE)
AS 
   /*
   *   SSMA warning messages:
   *   O2SS0273: Oracle SUBSTR function and SQL Server SUBSTRING function may give different results.
   */

   SELECT 
      J.JURISDICTION_SITE_ID AS UNIQUE_KEY, 
      CASE REPT.STATUS
         WHEN 'O' THEN 'Yes'
         ELSE 'No'
      END AS HISTORY_VERSION, 
      CASE REPT.STATUS
         WHEN 'D' THEN 'Yes'
         ELSE 'No'
      END AS DELETED, 
      CASE REPT.CREATED_BY
         WHEN NULL THEN 'Yes'
         ELSE 'No'
      END AS FOREIGN_DOC, 
      REPT.WEB_PAGE_LINK, 
      DS.COMMENTS AS DATASHARE_COMMENTS, 
      CASE REPT.IS_OWNER
         WHEN 'Y' THEN 'Local'
         ELSE 'No'
      END AS OWNED_BY, 
      J.JURISDICTION_NAME, 
      ISNULL(upper(substring(PV.COLOR_IMG_KEY, 7, (ssma_oracle.instr4_varchar(PV.COLOR_IMG_KEY, '.', 7, 1) - 7))), '') + ' - ' + ISNULL(PV.PICKLIST_VALUE, '') AS STATUS, 
      J.CITY, 
      J.COUNTY_NAME, 
      J.STATE_NAME, 
      J.CURRENT_OBJECTIVES, 
      J.PROJECTED_OBJECTIVES, 
      J.CONCERNS_PROBLEMS, 
      RR.RELATED_REPORT_NAME, 
      J.DATE_REQUESTED_LOCAL, 
      J.DATE_REQUESTED_INTERMEDIATE, 
      J.DATE_REQUESTED_GUBERNATORIAL, 
      J.DATE_REQUESTED_PRESIDENTIAL, 
      J.DATE_GRANTED_LOCAL, 
      J.DATE_GRANTED_INTERMEDIATE, 
      J.DATE_GRANTED_GUBERNATORIAL, 
      J.DATE_GRANTED_PRESIDENTIAL, 
      J.INTERMEDIATE_LEVEL, 
      J.ESTIMATED_FATALITIES, 
      CAST(J.ESTIMATED_FATALITIES AS numeric(38, 10)) AS ESTIMATED_FATALITIES_INT, 
      J.CONFIRMED_FATALITIES, 
      CAST(J.CONFIRMED_FATALITIES AS numeric(38, 10)) AS CONFIRMED_FATALITIES_INT, 
      J.FATALITIES_COMMENT, 
      J.ESTIMATED_INJURIES, 
      CAST(J.ESTIMATED_INJURIES AS numeric(38, 10)) AS ESTIMATED_INJURIES_INT, 
      J.CONFIRMED_INJURIES, 
      CAST(J.CONFIRMED_INJURIES AS numeric(38, 10)) AS CONFIRMED_INJURIES_INT, 
      J.INJURIES_COMMENT, 
      J.RESIDENCES_DESTROYED, 
      CAST(J.RESIDENCES_DESTROYED AS numeric(38, 10)) AS RESIDENCES_DESTROYED_INT, 
      J.RESIDENCE_MAJOR, 
      CAST(J.RESIDENCE_MAJOR AS numeric(38, 10)) AS RESIDENCE_MAJOR_INT, 
      J.RESIDENCES_MINOR, 
      CAST(J.RESIDENCES_MINOR AS numeric(38, 10)) AS RESIDENCES_MINOR_INT, 
      J.RESIDENCES_AFFECTED, 
      CAST(J.RESIDENCES_AFFECTED AS numeric(38, 10)) AS RESIDENCES_AFFECTED_INT, 
      J.RESIDENCES_ESTIMATED_COST, 
      CAST(J.RESIDENCES_ESTIMATED_COST AS numeric(38, 10)) AS RESIDENCES_ESTIMATED_COST_FL, 
      J.RESIDENCES_INSURED, 
      CAST(J.RESIDENCES_INSURED AS numeric(38, 10)) AS RESIDENCES_INSURED_FL, 
      J.BUSINESS_DESTROYED, 
      CAST(J.BUSINESS_DESTROYED AS numeric(38, 10)) AS BUSINESS_DESTROYED_INT, 
      J.BUSINESS_MAJOR, 
      CAST(J.BUSINESS_MAJOR AS numeric(38, 10)) AS BUSINESS_MAJOR_INT, 
      J.BUSINESS_MINOR, 
      CAST(J.BUSINESS_MINOR AS numeric(38, 10)) AS BUSINESS_MINOR_INT, 
      J.BUSINESS_AFFECTED, 
      CAST(J.BUSINESS_AFFECTED AS numeric(38, 10)) AS BUSINESS_AFFECTED_INT, 
      J.BUSINESS_ESTIMATED_COST, 
      CAST(J.BUSINESS_ESTIMATED_COST AS numeric(38, 10)) AS BUSINESS_ESTIMATED_COST_FL, 
      J.BUSINESS_INSURED, 
      CAST(J.BUSINESS_INSURED AS numeric(38, 10)) AS BUSINESS_INSURED_FL, 
      J.GOVERNMENT_DESTROYED, 
      CAST(J.GOVERNMENT_DESTROYED AS numeric(38, 10)) AS GOVERNMENT_DESTROYED_INT, 
      J.GOVERNMENT_MAJOR, 
      CAST(J.GOVERNMENT_MAJOR AS numeric(38, 10)) AS GOVERNMENT_MAJOR_INT, 
      J.GOVERNMENT_MINOR, 
      CAST(J.GOVERNMENT_MINOR AS numeric(38, 10)) AS GOVERNMENT_MINOR_INT, 
      J.GOVERNMENT_AFFECTED, 
      CAST(J.GOVERNMENT_AFFECTED AS numeric(38, 10)) AS GOVERNMENT_AFFECTED_INT, 
      J.GOVERNMENT_ESTIMATED_COST, 
      CAST(J.GOVERNMENT_ESTIMATED_COST AS numeric(38, 10)) AS GOVERNMENT_ESTIMATED_COST_FL, 
      J.GOVERNMENT_INSURED, 
      CAST(J.GOVERNMENT_INSURED AS numeric(38, 10)) AS GOVERNMENT_INSURED_FL, 
      (CAST(replace(CAST(J.RESIDENCES_ESTIMATED_COST AS varchar(max)), ',', NULL) AS numeric(38, 10)) + CAST(replace(CAST(J.BUSINESS_ESTIMATED_COST AS varchar(max)), ',', NULL) AS numeric(38, 10)) + CAST(replace(CAST(J.GOVERNMENT_ESTIMATED_COST AS varchar(max)), ',', NULL) AS numeric(38, 10))) AS TOTAL_ESTIMATED_COST, 
      J.CAT_A_NO_OF_SITES, 
      CAST(J.CAT_A_NO_OF_SITES AS numeric(38, 10)) AS CAT_A_NO_OF_SITES_INT, 
      J.CAT_A_ESTIMATED_LOSS, 
      CAST(J.CAT_A_ESTIMATED_LOSS AS numeric(38, 10)) AS CAT_A_ESTIMATED_LOSS_FL, 
      J.CAT_B_NO_OF_SITES, 
      CAST(J.CAT_B_NO_OF_SITES AS numeric(38, 10)) AS CAT_B_NO_OF_SITES_INT, 
      J.CAT_B_ESTIMATED_LOSS, 
      CAST(J.CAT_B_ESTIMATED_LOSS AS numeric(38, 10)) AS CAT_B_ESTIMATED_LOSS_FL, 
      J.CAT_C_NO_OF_SITES, 
      CAST(J.CAT_C_NO_OF_SITES AS numeric(38, 10)) AS CAT_C_NO_OF_SITES_INT, 
      J.CAT_C_ESTIMATED_LOSS, 
      CAST(J.CAT_C_ESTIMATED_LOSS AS numeric(38, 10)) AS CAT_C_ESTIMATED_LOSS_FL, 
      J.CAT_D_NO_OF_SITES, 
      CAST(J.CAT_D_NO_OF_SITES AS numeric(38, 10)) AS CAT_D_NO_OF_SITES_INT, 
      J.CAT_D_ESTIMATED_LOSS, 
      CAST(J.CAT_D_ESTIMATED_LOSS AS numeric(38, 10)) AS CAT_D_ESTIMATED_LOSS_FL, 
      J.CAT_E_NO_OF_SITES, 
      CAST(J.CAT_E_NO_OF_SITES AS numeric(38, 10)) AS CAT_E_NO_OF_SITES_INT, 
      J.CAT_E_ESTIMATED_LOSS, 
      CAST(J.CAT_E_ESTIMATED_LOSS AS numeric(38, 10)) AS CAT_E_ESTIMATED_LOSS_FL, 
      J.CAT_F_NO_OF_SITES, 
      CAST(J.CAT_F_NO_OF_SITES AS numeric(38, 10)) AS CAT_F_NO_OF_SITES_INT, 
      J.CAT_F_ESTIMATED_LOSS, 
      CAST(J.CAT_F_ESTIMATED_LOSS AS numeric(38, 10)) AS CAT_F_ESTIMATED_LOSS_FL, 
      J.CAT_G_NO_OF_SITES, 
      CAST(J.CAT_G_NO_OF_SITES AS numeric(38, 10)) AS CAT_G_NO_OF_SITES_INT, 
      J.CAT_G_ESTIMATED_LOSS, 
      CAST(J.CAT_G_ESTIMATED_LOSS AS numeric(38, 10)) AS CAT_G_ESTIMATED_LOSS_FL, 
      
         CAST(replace(CAST(J.CAT_A_NO_OF_SITES AS varchar(max)), ',', NULL) AS numeric(38, 10))
          + 
         CAST(replace(CAST(J.CAT_B_NO_OF_SITES AS varchar(max)), ',', NULL) AS numeric(38, 10))
          + 
         CAST(replace(CAST(J.CAT_C_NO_OF_SITES AS varchar(max)), ',', NULL) AS numeric(38, 10))
          + 
         CAST(replace(CAST(J.CAT_D_NO_OF_SITES AS varchar(max)), ',', NULL) AS numeric(38, 10))
          + 
         CAST(replace(CAST(J.CAT_E_NO_OF_SITES AS varchar(max)), ',', NULL) AS numeric(38, 10))
          + 
         CAST(replace(CAST(J.CAT_F_NO_OF_SITES AS varchar(max)), ',', NULL) AS numeric(38, 10))
          + 
         CAST(replace(CAST(J.CAT_G_NO_OF_SITES AS varchar(max)), ',', NULL) AS numeric(38, 10)) AS TOTAL_NO_OF_SITES, 
      (
         CAST(replace(CAST(J.CAT_A_ESTIMATED_LOSS AS varchar(max)), ',', NULL) AS numeric(38, 10))
          + 
         CAST(replace(CAST(J.CAT_B_ESTIMATED_LOSS AS varchar(max)), ',', NULL) AS numeric(38, 10))
          + 
         CAST(replace(CAST(J.CAT_C_ESTIMATED_LOSS AS varchar(max)), ',', NULL) AS numeric(38, 10))
          + 
         CAST(replace(CAST(J.CAT_D_ESTIMATED_LOSS AS varchar(max)), ',', NULL) AS numeric(38, 10))
          + 
         CAST(replace(CAST(J.CAT_E_ESTIMATED_LOSS AS varchar(max)), ',', NULL) AS numeric(38, 10))
          + 
         CAST(replace(CAST(J.CAT_F_ESTIMATED_LOSS AS varchar(max)), ',', NULL) AS numeric(38, 10))
          + 
         CAST(replace(CAST(J.CAT_G_ESTIMATED_LOSS AS varchar(max)), ',', NULL) AS numeric(38, 10))) AS TOTAL_ESTIMATED_LOSS, 
      J.PEOPLE_EVACUATED, 
      CAST(J.PEOPLE_EVACUATED AS numeric(38, 10)) AS PEOPLE_EVACUATED_INT, 
      J.PEOPLE_IN_SHELTERS, 
      CAST(J.PEOPLE_IN_SHELTERS AS numeric(38, 10)) AS PEOPLE_IN_SHELTERS_INT, 
      J.COMMENTS, 
      J.ADDITIONAL_COMMENTS, 
      REPT.CREATION_DATE, 
      CASE 
         WHEN UC.USER_NAME IS NULL THEN 
            (
               SELECT TBL_REMOTE_DOCUMENT_USER_INFO.CREATED_BY_USER_LOGIN_ID
               FROM EMBCPROD.TBL_REMOTE_DOCUMENT_USER_INFO
               WHERE TBL_REMOTE_DOCUMENT_USER_INFO.GLOBAL_REPORT_ID = J.JURISDICTION_SITE_ID
            )
         ELSE UC.USER_NAME
      END AS CREATED_BY, 
      REPT.MODIFICATION_DATE, 
      CASE 
         WHEN UM.USER_NAME IS NULL THEN 
            (
               SELECT TBL_REMOTE_DOCUMENT_USER_INFO$2.MODIFIED_BY_USER_LOGIN_ID
               FROM EMBCPROD.TBL_REMOTE_DOCUMENT_USER_INFO  AS TBL_REMOTE_DOCUMENT_USER_INFO$2
               WHERE TBL_REMOTE_DOCUMENT_USER_INFO$2.GLOBAL_REPORT_ID = J.JURISDICTION_SITE_ID
            )
         ELSE UM.USER_NAME
      END AS MODIFIED_BY, 
      
         (
            SELECT TBL_EEMS_CONFIGURATION.CUSTOMER_TIMEZONE
            FROM EMBCPROD.TBL_EEMS_CONFIGURATION, EMBCPROD.TBL_REPORT
            WHERE TBL_EEMS_CONFIGURATION.CONFIGURATION_ID = TBL_REPORT.GLOBAL_REPORT_ID AND TBL_REPORT.STATUS = 'A'
         ) AS TIMEZONE
   FROM 
      (EMBCPROD.TBL_JURISDICTION_SITE_REP  AS J 
         LEFT JOIN EMBCPROD.TBL_PICKLIST_VALUE  AS PV 
         ON J.CURRENT_STATUS = PV.PICKLIST_VALUE_ID), 
      ((((EMBCPROD.TBL_REPORT  AS REPT 
         LEFT JOIN EMBCPROD.TBL_LOCATION  AS L 
         ON REPT.LOCATION_ID = L.LOCATION_ID) 
         LEFT JOIN EMBCPROD.TBL_GEO_LOCATION_MAPPING  AS G 
         ON REPT.GEO_LOCATION_MAPPING_ID = G.GEO_LOCATION_MAPPING_ID) 
         LEFT JOIN EMBCPROD.TBL_RESPONSIBLE_ENTITY  AS RE 
         ON REPT.ENTITY_ID = RE.ENTITY_ID) 
         LEFT JOIN EMBCPROD.TBL_DATA_SHARING  AS DS 
         ON REPT.DATA_SHARING_ID = DS.DATA_SHARING_ID) 
         LEFT JOIN EMBCPROD.TBL_RELATED_REPORT  AS RR 
         ON 
            REPT.GLOBAL_REPORT_ID = RR.GLOBAL_REPORT_ID AND 
            RR.RELATED_REPORT_TYPE = 'EIA' AND 
            RR.RELATED_GLOBAL_REPORT_ID IN 
            (
               SELECT TBL_REPORT$2.GLOBAL_REPORT_ID
               FROM EMBCPROD.TBL_REPORT  AS TBL_REPORT$2
               WHERE TBL_REPORT$2.STATUS IN ( 'A', 'C', 'D' )
            ) 
         LEFT JOIN EMBCPROD.TBL_REPORT  AS UCR 
         ON UCR.REPORT_ID = REPT.CREATED_BY 
         LEFT JOIN EMBCPROD.TBL_USER  AS UC 
         ON UCR.GLOBAL_REPORT_ID = UC.USER_ID AND UCR.STATUS IN ( 'A', 'D' ) 
         LEFT JOIN EMBCPROD.TBL_REPORT  AS UMR 
         ON UMR.REPORT_ID = REPT.MODIFIED_BY 
         LEFT JOIN EMBCPROD.TBL_USER  AS UM 
         ON UM.USER_ID = UMR.GLOBAL_REPORT_ID AND UMR.STATUS IN ( 'A', 'D' )
   WHERE J.JURISDICTION_SITE_ID = REPT.GLOBAL_REPORT_ID

GO
EXECUTE sp_addextendedproperty @name = N'MS_SSMA_SOURCE', @value = N'EMBCPROD.V_JURIS_SITREP', @level0type = N'SCHEMA', @level0name = N'EMBCPROD', @level1type = N'VIEW', @level1name = N'V_JURIS_SITREP';

